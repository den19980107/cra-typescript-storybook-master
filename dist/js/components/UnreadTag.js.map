{"version":3,"sources":["../../../src/components/UnreadTag.tsx"],"names":["props","console","log","unreadTagDomRef","React","createRef","toogle","bind","moveToBottom","scrollToTag","state","visible","that","firstUnreadId","lastHistoryId","mutation","observer","hasChildNodes","firstElementChild","getAttribute","disconnect","Store","ActionObservable","subscribe","action","type","activity","payload","id","setTimeout","unsubscribe","display","setState","unreadTag","current","closest","append","immediatelyInvoked","logContainer","parentElement","scrollHeight","clientHeight","scroll","addEventListener","waitHistoryLoaded","scrollTop","removeEventListener","Math","max","offsetTop","Component"],"mappings":"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","sourcesContent":["import React from 'react'\nimport Store from '../utils/Store'\nimport createMessageMutationObserver from '../utils/createMessageMutationObserver'\n\ninterface UnreadTagProps {\n    firstUnreadId: string,\n    lastHistoryId: string\n}\n\ninterface UnreadTagState {\n    visible: boolean\n}\n\nexport default class extends React.Component<UnreadTagProps, UnreadTagState> {\n    unreadTagDomRef: React.RefObject<HTMLDivElement>\n\n    constructor(props: Readonly<UnreadTagProps>) {\n        super(props)\n        console.log('UnreadTag constructor.')\n\n        this.unreadTagDomRef = React.createRef()\n\n        this.toogle = this.toogle.bind(this)\n        this.moveToBottom = this.moveToBottom.bind(this)\n        this.scrollToTag = this.scrollToTag.bind(this)\n\n        this.state = {\n            visible: false\n        }\n    }\n\n    componentDidMount() {\n        const that = this\n        let { firstUnreadId, lastHistoryId } = this.props\n\n        if (firstUnreadId) {\n            // 使用 MutationObserver 當 dom rendered 後再調整 scrollbar。\n            createMessageMutationObserver((mutation: HTMLLIElement, observer: MutationObserver) => {\n                if (mutation.hasChildNodes && mutation.firstElementChild.getAttribute('data-key') === this.props.lastHistoryId) {\n                    observer.disconnect()\n                    this.scrollToTag(false)\n                }\n            })\n        }\n\n        Store.ActionObservable.subscribe(function subscribe(action) {\n            console.log('UnreadTag ActionObservable.')\n\n            if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {\n                const { activity } = action.payload\n\n                if (firstUnreadId && activity.id === firstUnreadId) {\n                    that.moveToBottom().toogle(true)\n                    firstUnreadId = null\n                    lastHistoryId = null\n                }\n                else if (lastHistoryId && activity.id === lastHistoryId) {\n                    setTimeout(() => that.moveToBottom())\n                    lastHistoryId = null\n                }\n\n                if (!firstUnreadId && !lastHistoryId) {\n                    Store.ActionObservable.unsubscribe(subscribe)\n                }\n            }\n        })\n    }\n\n    toogle(display: boolean) {\n        this.setState({ visible: display })\n\n        return this\n    }\n\n    moveToBottom() {\n        const unreadTag = this.unreadTagDomRef.current\n        console.log('moveToBottom')\n        unreadTag.closest('ul').append(unreadTag.closest('li'))\n\n        return this\n    }\n\n    scrollToTag(immediatelyInvoked: boolean) {\n        const unreadTag = this.unreadTagDomRef.current\n        const logContainer = unreadTag.parentElement.closest('div')\n\n        //判斷是否有 scrollbar\n        if (logContainer.scrollHeight > logContainer.clientHeight) {\n            if (immediatelyInvoked) {\n                scroll()\n            }\n            else {\n                logContainer.addEventListener('scroll', function waitHistoryLoaded() {\n                    // 載完對話後，webchat 會做 scrollToEnd，這時候再將 scrollbar 定位到 unread tag。\n                    if (logContainer.clientHeight + logContainer.scrollTop >= logContainer.scrollHeight) {\n                        scroll()\n                        logContainer.removeEventListener('scroll', waitHistoryLoaded)\n                    }\n                })\n            }\n        }\n\n        function scroll() {\n            logContainer.scrollTop = Math.max(unreadTag.offsetTop - 30, 0)\n        }\n\n        return this\n    }\n\n    //tag style ref: \n    //'border:2px #ccc solidborder-radius:10pxwidth:90%height: 20pxbackground-color:#eeetext-align: centermargin: auto'\n\n    render() {\n        const { visible } = this.state\n\n        return <div ref={this.unreadTagDomRef} className=\"unread-tag\" hidden={!visible}>以下爲尚未閱讀的訊息</div>\n    }\n}"],"file":"UnreadTag.js"}